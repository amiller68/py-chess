name: CD

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      deploy-chess: ${{ steps.filter.outputs.chess }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            chess:
              - 'src/**'
              - 'templates/**'
              - 'static/**'
              - 'alembic/**'
              - 'Dockerfile'
              - 'pyproject.toml'
              - 'uv.lock'
              - 'bin/kamal'
              - 'bin/iac'
              - 'config/deploy/chess.yml'
              - '.github/workflows/cd.yml'

  deploy-chess:
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy-chess == 'true'
    runs-on: ubuntu-latest
    environment: production
    env:
      DOCKER_BUILDKIT: 1
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      CI: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2

      - name: Install Kamal
        run: gem install kamal --version 2.4.0

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify 1Password Access
        run: |
          source bin/vault
          echo "Testing 1Password access..."
          op whoami

      - name: Initialize Terraform
        run: bin/iac production init -input=false

      - name: Setup SSH Agent
        run: |
          mkdir -p .kamal
          chmod 700 .kamal

          echo "Getting SSH key from Terraform..."
          SSH_KEY=$(bin/iac production output -raw ssh_private_key 2>&1)

          echo "Output lines: $(echo "$SSH_KEY" | wc -l)"

          if [ -z "$SSH_KEY" ] || ! echo "$SSH_KEY" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "Error: Failed to retrieve valid SSH key from Terraform"
            echo "Got: $SSH_KEY"
            exit 1
          fi

          echo "Successfully retrieved SSH key"

          eval $(ssh-agent -s)

          echo "Adding SSH key to agent..."
          ssh-add - <<< "$SSH_KEY"

          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

          echo "Keys in agent:"
          ssh-add -l

      - name: Setup SSH config
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            BatchMode yes
          EOF
          chmod 600 ~/.ssh/config

      - name: Deploy Chess app
        run: |
          bin/kamal chess production deploy
