<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>{% block title %}py-chess{% endblock %}</title>

        <!-- Hot reloading for development mode -->
        <script>
            if (window.location.hostname === "localhost") {
                const hotReload = new EventSource("/dev/hot-reload");

                hotReload.addEventListener("connected", function (e) {
                    console.log("Hot reload connected:", e.data);
                });

                hotReload.addEventListener("reload", function (e) {
                    console.log("Hot reload triggered:", e.data);
                    location.reload();
                });

                hotReload.onerror = function (e) {
                    console.error("Hot reload error:", e);
                    setTimeout(() => {
                        hotReload.close();
                        location.reload();
                    }, 5000);
                };
            }
        </script>

        <!-- Inter font -->
        <link rel="preconnect" href="https://rsms.me/" />
        <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

        <style>
            :root {
                font-family: Inter, sans-serif;
                font-feature-settings:
                    "liga" 1,
                    "calt" 1;
            }
            @supports (font-variation-settings: normal) {
                :root {
                    font-family: InterVariable, sans-serif;
                }
            }
        </style>

        <!-- Franken UI -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/franken-ui@next/dist/css/core.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/franken-ui@next/dist/css/utilities.min.css"
        />

        <script>
            const htmlElement = document.documentElement;
            const __FRANKEN__ = JSON.parse(
                localStorage.getItem("__FRANKEN__") || "{}",
            );

            if (
                __FRANKEN__.mode === "dark" ||
                (!__FRANKEN__.mode &&
                    window.matchMedia("(prefers-color-scheme: dark)").matches)
            ) {
                htmlElement.classList.add("dark");
            } else {
                htmlElement.classList.remove("dark");
            }

            if (__FRANKEN__.theme) {
                htmlElement.classList.add(__FRANKEN__.theme);
            }
            htmlElement.classList.add(__FRANKEN__.radii || "uk-radii-md");
            htmlElement.classList.add(__FRANKEN__.shadows || "uk-shadows-sm");
            htmlElement.classList.add(__FRANKEN__.font || "uk-font-sm");
        </script>

        <script
            type="module"
            src="https://cdn.jsdelivr.net/npm/franken-ui@next/dist/js/core.iife.js"
        ></script>

        <!-- HTMX -->
        <script src="https://unpkg.com/htmx.org@2.0.0"></script>
        <!-- HTMX SSE Extension -->
        <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>

        <!-- Static Assets -->
        <link rel="stylesheet" href="/static/css/main.css" />

        {% block head %}{% endblock %}
    </head>
    <body class="bg-background text-foreground">
        {% block body %}{% endblock %}

        <script
            type="module"
            src="https://cdn.jsdelivr.net/npm/franken-ui@next/dist/js/icon.iife.js"
        ></script>

        <!-- Global initialization system -->
        <script>
            window.AppInit = window.AppInit || {
                handlers: [],
                register: function (handler) {
                    this.handlers.push(handler);
                },
                run: function () {
                    this.handlers.forEach((handler) => {
                        try {
                            handler();
                        } catch (e) {
                            console.error("Error in initialization handler:", e);
                        }
                    });
                },
            };

            document.addEventListener("DOMContentLoaded", function () {
                window.AppInit.run();
            });

            document.body.addEventListener("htmx:afterSwap", function (event) {
                setTimeout(function () {
                    window.AppInit.run();
                }, 10);
            });
        </script>
    </body>
</html>
